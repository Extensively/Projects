<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Goated Chatroom</title>
<style>


  .navbar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    background-color: #333;
    width: 100vw;
    margin: 0;
    padding: 0;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    height: 48px;
    box-sizing: border-box;
    border-bottom: 2px solid #222;
  }

  .navbar a {
    font-size: 16px;
    color: white;
    text-align: center;
    padding: 12px 18px;
    text-decoration: none;
    transition: background 0.2s;
    border-radius: 4px;
    margin: 0 2px;
    display: flex;
    align-items: center;
    height: 100%;
  }

  .navbar a:hover {
    background-color: red;
    color: #fff;
  }

html, body {
  margin: 0;
  padding: 0;
  width: 100vw;
  box-sizing: border-box;
}
  body { font-family: sans-serif; background: #4e4e4e; padding: 20px; }
  #chat { border: 1px solid #5b5b5b; background: #434343; padding: 10px; height: 300px; overflow-y: auto; }
  #userlist { border: 1px solid #ccc; background: #eef; padding: 10px; display: none; }
  .msg { margin: 5px 0; }
  .system { color: gray; font-style: italic; }
  .user { font-weight: bold; }
  .gpt { color: #0077cc; }

     @keyframes rainbow {
      0% {
        color: red;
      }
      20% {
        color: yellow;
      }
      40% {
        color: green;
      }
      60% {
        color: blue;
      }
      80% {
        color: violet;
      }
	   100% {
        color: red;
      }
    }

    .rainbowslow {
     animation: rainbow 20s infinite;
	   animation-duration: infinite;
 	   animation-timing-function: linear;
    }
	
    .rainbowfast {
     animation: rainbow 2s infinite;
	   animation-duration: infinite;
 	   animation-timing-function: linear;
    }
</style>
</head>
<body>
<div class="navbar">
  <a href="index.html">Home</a>
  <a href="about.html">About</a>
  <a href="memes.html">Memes</a>
  <a href="minesweeper.html">Minesweeper</a>
  <a class="rainbowfast">Chat</a>
</div>
<br>
<h1>Goated Chat.</h1>

<div id="online">Online: 0</div>
<button id="toggleUsers">Show Users</button>
<div id="userlist"></div>

<div id="chat"></div>
<input id="input" placeholder="Type a message..." />
<button id="send">Send</button>
<input type="file" id="imageInput" accept="image/*" />
<button id="sendImage">Send Image</button>
<br><br>
<p>Commands: <code>/clear</code> to clear chat.</p>
<p>Mention <code>@nathangpt</code> to chat with the AI bot

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js";
const imageInput = document.getElementById("imageInput");
const sendImageBtn = document.getElementById("sendImage");
const socket = io("https://projects-p0mx.onrender.com"); // change to your deployed server
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const online = document.getElementById("online");
const userlist = document.getElementById("userlist");
const toggleUsers = document.getElementById("toggleUsers");

let username = prompt("Enter your username:");
socket.emit("set_username", username);

function addMessage(sender, text, cls = "", img = null) {
  const div = document.createElement("div");
  div.className = "msg " + cls;

  if (img) {
    div.innerHTML = `<span class="user">${sender}:</span><br><img src="${img}" style="max-width:200px; max-height:200px;">`;
  } else {
    div.innerHTML = `<span class="user">${sender}:</span> ${text}`;
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}


function updateUsers(users) {
  online.innerText = "Online: " + users.length;
  userlist.innerHTML = users.join("<br>");
}

toggleUsers.onclick = () => {
  userlist.style.display = userlist.style.display === "none" ? "block" : "none";
  toggleUsers.innerText = userlist.style.display === "none" ? "Show Users" : "Hide Users";
};

// --- Socket.IO events ---
socket.on("chat_history", (history) => {
  chat.innerHTML = "";
  history.forEach(msg => {
    const cls = msg.type === "system" ? "system" : (msg.username === "GPT" ? "gpt" : "");
    addMessage(msg.username, msg.msg, cls);
  });
});

socket.on("chat_message", (msg) => {
  const cls = msg.type === "system" ? "system" : (msg.username === "GPT" ? "gpt" : "");
  if (msg.type === "image") {
    addMessage(msg.username, "", cls, msg.img);
  } else {
    addMessage(msg.username, msg.msg, cls);
  }
});


socket.on("update_users", (users) => {
  updateUsers(users);
});

// --- Sending messages + GPT handling ---
sendBtn.onclick = () => {
  const msg = input.value.trim();
  if (!msg) return;

  // Slash commands
  if (msg.startsWith("/")) {
    handleCommand(msg);
    input.value = "";
    return;
  }

  socket.emit("chat_message", { username, msg });
  input.value = "";

  if (msg.startsWith("@nathangpt")) handleGPT(msg.replace("@nathangpt", "").trim());
};


input.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
});

// --- Client-side GPT ---
let generator = null;
async function loadModel() {
  if (!generator) {
    addMessage("GPT", "Loading GPT model...", "gpt");

    generator = await pipeline("text-generation", "Xenova/gpt2", {
      progress_callback: (progress) => {
        // progress is between 0 and 1
        const percent = Math.floor(progress * 100);
        // update last GPT message
        const last = chat.querySelector(".msg.gpt:last-child");
        if (last) last.innerText = `GPT model downloading: ${percent}%`;
      }
    });

    // Once done
    addMessage("NATHANGPT", "Model loaded! You can now use @nathangpt.", "gpt");
  }
}


async function handleGPT(prompt) {
  await loadModel();
  addMessage("NATHANGPT", "thinking...", "gpt");

  const promptTemplate = `You are a helpful AI chatbot. User: ${prompt}\nAI:`;
  const output = await generator(promptTemplate, {
    max_new_tokens: 80,
    temperature: 0.7,
    top_p: 0.9,
    do_sample: true
  });

  const reply = output[0].generated_text.replace(promptTemplate, "").trim();
  socket.emit("chat_message", { username: "NATHANGPT", msg: reply });
}
sendImageBtn.onclick = () => {
  const file = imageInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const dataUrl = reader.result; // base64 image string
    socket.emit("chat_message", {
      username,
      type: "image",
      img: dataUrl
    });
  };
  reader.readAsDataURL(file);

  imageInput.value = ""; // reset input
};

function handleCommand(msg) {
  const parts = msg.split(" ");
  const command = parts[0].toLowerCase();

  switch (command) {
    case "/clear":
      chat.innerHTML = "";
      socket.emit("chat_message", { username: "System", msg: `${username} cleared the chat`, type: "system" });
      break;

    default:
      addMessage("System", `Unknown command: ${command}`, "system");
  }
}

</script>
</body>
</html>
